---
layout: post
title: "엘라스틱서치로 인기검색어 모니터링 해보자 (1) - 엘라스틱서치에 액세스로그 쌓기"
date: 2020-03-24 00:12:12
categories: 엘라스틱서치
author: bactoria

---

지난번에 6주간 했던 푸드트럭 프로젝트는 Nginx를 이용하면서 액세스 로그를 쌓아왔기에, 이를 키바나로 시각화하고 싶었다.

목표는  이용자들의 인기검색어를 키바나로 모니터링 해보는 것.

---

### 개발 환경

- OS : Ubuntu 18.04.1 LTS
  - Nginx : 1.14.0
  - Logstash: 7.4.1
- ElasticSearch: Amazon Elasticsearch Service (7.4)
- Kibana: Amazon Elasticsearch Service (7.4)

대략적인 인프라는 (TODO)



---



인기검색어를 뽑아내기 위해서는 사용자가 검색했던 데이터가 필요할 것이다.

우리 프로젝트는 Nginx로 들어오는 로그를 남긴다.



**/etc/nginx/nginx.conf**

```nginx
# ...

http {
    # ...
  
    log_format main '{"time": "$time_iso8601", '
                    '"remote_addr": "$remote_addr", '
                    '"remote_user": "$remote_user", '
                    '"body_bytes_sent": $body_bytes_sent, '
                    '"request_time": $request_time, '
                    '"status": $status, '
                    '"request": "$request", '
                    '"request_method": "$request_method", '
                    '"http_referrer": "$http_referer", '
                    '"http_user_agent": "$http_user_agent"}';
  
    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    server {
		    # ...
    }
}
```

/var/log/nginx/access.log 에 {"time": ...} 형식으로 남긴다는 말이다.



**/var/log/nginx/access.log** 는 아래처럼 찍힌다.

```json
{"time": "2020-03-17T17:50:27+00:00", "remote_addr": "162.243.129.240", "remote_user": "-", "body_bytes_sent": 4801, "request_time": 0.000, "status": 200, "request": "GET / HTTP/1.1", "request_method": "GET", "http_referrer": "-", "http_user_agent": "Mozilla/5.0 zgrab/0.x"}
{"time": "2020-03-17T17:56:08+00:00", "remote_addr": "5.101.0.209", "remote_user": "-", "body_bytes_sent": 4801, "request_time": 0.000, "status": 200, "request": "GET /index.php?s=/Index/\x5Cthink\x5Capp/invokefunction&function=call_user_func_array&vars[0]=md5&vars[1][]=HelloThinkPHP HTTP/1.1", "request_method": "GET", "http_referrer": "-", "http_user_agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.108 Safari/537.36"}
// ...
```



---



## ELK 구축

사용자 검색에 대한 로그는 access.log 에 들어가 있다.

access.log 파일을 ElasticSearch 로 보내면 된다. 

그래서 약간의 준비과정이 필요하다.



### Amazon Elasticsearch Service 인스턴스 생성

<img width="278" alt="스크린샷 2020-03-19 오후 4 41 11" src="https://user-images.githubusercontent.com/25674959/77043244-75602180-6a00-11ea-9ac4-7191379e279d.png">

AWS의 Amazon Elasticsearch Service는 프리티어로 1년간 무료로 사용할 수 있는 인스턴스가 있다.

인스턴스를 생성하면 아래처럼 **엘라스틱서치** 엔드포인트와 **키바나** 주소가 나와있다.

![image-20200323234059290](/Users/bactoria/Library/Application Support/typora-user-images/image-20200323234059290.png)



---



### IAM 사용자 생성

로그스태시에서 엘라스틱서치로 데이터를 전송할 때 유효한 사용자인지를 판별하는 과정이 필요하다.

이를 IAM을 이용하여 해결하려 한다.

- 정책
  - 정책 생성
    - 서비스: Elasticsearch Service
    - 작업: 액세스 레벨 - 쓰기
    - 리소스: 특정 - 모두 선택
  - 정책 검토
    - 이름: <<정책 이름>>



- 사용자
  - 사용자 추가
    - 사용자 세부 정보 설정
      - 사용자 이름: <<사용자 이름>>
    - AWS 액세스 유형 선택
      - 액세스 유형: 프로그래밍 방식 액세스
    - 권한 설정
      - 기존 정책 직접 연결
        - <<위에서 생성한 정책 이름>> 선택



![image](https://user-images.githubusercontent.com/25674959/77045006-c4f41c80-6a03-11ea-9d50-cb0d8571f5f4.png)

**액세스 키**와 **비밀 액세스 키**는 나중에 로그스태시 설정할 때 사용하니 따로 기록해둔다.



---



### 로그스태시

로그스태시를 우리 프로젝트가 배포되어있는 EC2 인스턴스에 설치한다.

아래 명령어들은 **Ubuntu 18.04.1 LTS** 기준이다.



**로그스태시 설치**

```bash
> sudo wget https://artifacts.elastic.co/downloads/logstash/logstash-7.4.1.deb
> sudo dpkg -i logstash-7.4.1.deb
```



**플러그인 설치** - 로그스태시에서 엘라스틱서치(Amazon es)로 데이터 전송을 도와주는 플러그인 (output 에서 사용됨.)

```bash
> sudo /usr/share/logstash/bin/logstash-plugin install logstash-output-amazon_es
```



**로그스태시 메모리 설정 변경**

로그스태시가 실행되면 기본적으로 초기,최대 힙 사이즈가 1GB로 설정되어 있다.

각자 인스턴스 사정에 맞게 힙사이즈를 조정한다.

EC2 프리티어 (t2.micro) 의 경우 램이 1기가라서 줄여놓는 것이 기존 서비스에 영향이 덜 갈 것이다.



**/etc/logstash/jvm.options**

```bash
-Xms256M # JVM의 초기 힙 사이즈
-Xmx256M # JVM의 최대 힙 사이즈

# ...
```



---



## Elasticsearch 로 Access.log 전송하기

이제 Logstash 설정만 해주면 Elasticsearch로 로그를 전송할 수 있다.



**/etc/logstash/conf.d/logstash-test.conf**

```nginx
input {
  file {
     path => ["/var/log/nginx/access.log"]
   	 sincedb_path => "/dev/null"
     start_position => "beginning"
  }
}

filter { }

output {
  amazon_es {
    hosts => ["search-####-#####.ap-northeast-2.es.amazonaws.com"] # Amazon Elasticsearch service 엔드포인트
    region => "ap-northeast-2" # Amazon Elasticsearch service 인스턴스의 지역
    index => "nginx-access.log-%{+YYYY.MM}"
    aws_access_key_id => '#####################' # 위에서 발급한 사용자 액세스 키
    aws_secret_access_key => '##############################' # 위에서 발급한 사용자 비밀 액세스 키
  }
}
```



**로그스태시 실행**

```bash
> sudo service logstash start
```



---

### 키바나로 로그 확인

![image](https://user-images.githubusercontent.com/25674959/77327032-049d6a00-6d5e-11ea-95e9-0730df45945b.png)

인덱스명은 **nginx*** 로, 와일드카드를 사용하였다. (nginx 로 시작하는 인덱스들 모두가 검색 대상이다.)



---



![image](https://user-images.githubusercontent.com/25674959/77309877-b75ecf80-6d40-11ea-95bd-be6ea2e4fc52.png)



지금껏 Nginx의 Access.log 파일을 엘라스틱서치로 넣어보고,

넣은 데이터를 키바나로 확인하는 작업을 했다.



TODO:: message 쪼개기, 검색어를 가지고 Top5 보여주기